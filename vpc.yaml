AWSTemplateFormatVersion: 2010-09-09
Description: Template for Best Practice VPC with 1-3 AZs

Parameters:
  VpcCidr:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-4]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-24.
    Default: 10.0.0.0/16
    Description: CIDR block for VPC.
    Type: String
  AvailabilityZoneCount:
    ConstraintDescription: "The number of availability zones. (Min: 1, Max: 3)"
    MinValue: 1
    MaxValue: 3
    Default: 1
    Description: "How many AZs to create VPC subnets for. (Min: 1, Max: 3)"
    Type: Number
  SubnetBits:
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/19-27.
    MinValue: 5
    MaxValue: 13
    Default: 12
    Description: "Size of each subnet to create within the availability zones. (Min: 5 = /27, Max: 13 = /19)"
    Type: Number
  EnableNatGateways:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Create NAT gateways for private subnet internet access
  EnableS3Endpoint:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Create S3 VPC Gateway Endpoint (free)
  EnableDynamoDbEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create DynamoDB VPC Gateway Endpoint (free)
  EnableSsmEndpoints:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create SSM VPC endpoints for Session Manager (ssm, ec2messages, ssmmessages)
  EnableLogsEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create CloudWatch Logs VPC endpoint
  EnableKmsEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create KMS VPC endpoint
  EnableStsEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create STS VPC endpoint
  EnableSecretsManagerEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create Secrets Manager VPC endpoint
  EnableSqsEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create SQS VPC endpoint
  EnableSnsEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create SNS VPC endpoint
  EnableMonitoringEndpoint:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create CloudWatch Monitoring VPC endpoint
  EnableEcrEndpoints:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Create ECR VPC endpoints for container image pulling (ecr.api, ecr.dkr)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: "Network Configuration"
      Parameters:
      - VpcCidr
      - SubnetBits
    - Label:
        default: "Availability Zones"
      Parameters:
      - AvailabilityZoneCount
    - Label:
        default: "Internet Access"
      Parameters:
      - EnableNatGateways
    - Label:
        default: "VPC Gateway Endpoints (Free)"
      Parameters:
      - EnableS3Endpoint
      - EnableDynamoDbEndpoint
    - Label:
        default: "VPC Interface Endpoints - SSM Access"
      Parameters:
      - EnableSsmEndpoints
    - Label:
        default: "VPC Interface Endpoints - Core Services"
      Parameters:
      - EnableLogsEndpoint
      - EnableKmsEndpoint
      - EnableStsEndpoint
      - EnableSecretsManagerEndpoint
    - Label:
        default: "VPC Interface Endpoints - Messaging"
      Parameters:
      - EnableSqsEndpoint
      - EnableSnsEndpoint
      - EnableMonitoringEndpoint
    - Label:
        default: "VPC Interface Endpoints - Containers"
      Parameters:
      - EnableEcrEndpoints
    ParameterLabels:
      AvailabilityZoneCount:
        default: "Availability Zone Count"
      VpcCidr:
        default: "VPC CIDR"
      SubnetBits:
        default: "Bits Per Subnet"
      EnableNatGateways:
        default: "Enable NAT Gateways"
      EnableS3Endpoint:
        default: "Enable S3 Endpoint"
      EnableDynamoDbEndpoint:
        default: "Enable DynamoDB Endpoint"
      EnableSsmEndpoints:
        default: "Enable SSM Endpoints"
      EnableLogsEndpoint:
        default: "Enable CloudWatch Logs Endpoint"
      EnableKmsEndpoint:
        default: "Enable KMS Endpoint"
      EnableStsEndpoint:
        default: "Enable STS Endpoint"
      EnableSecretsManagerEndpoint:
        default: "Enable Secrets Manager Endpoint"
      EnableSqsEndpoint:
        default: "Enable SQS Endpoint"
      EnableSnsEndpoint:
        default: "Enable SNS Endpoint"
      EnableMonitoringEndpoint:
        default: "Enable CloudWatch Monitoring Endpoint"
      EnableEcrEndpoints:
        default: "Enable ECR Endpoints"

Conditions:
  DoAz3: !Equals [3, !Ref AvailabilityZoneCount]
  DoAz2: !Or [!Equals [2, !Ref AvailabilityZoneCount], Condition: DoAz3]
  DoNat: !Equals ['true', !Ref EnableNatGateways]
  DoNatAz2: !And [Condition: DoAz2, Condition: DoNat]
  DoNatAz3: !And [Condition: DoAz3, Condition: DoNat]
  DoS3Endpoint: !Equals ['true', !Ref EnableS3Endpoint]
  DoDynamoDbEndpoint: !Equals ['true', !Ref EnableDynamoDbEndpoint]
  DoSsmEndpoints: !Equals ['true', !Ref EnableSsmEndpoints]
  DoLogsEndpoint: !Equals ['true', !Ref EnableLogsEndpoint]
  DoKmsEndpoint: !Equals ['true', !Ref EnableKmsEndpoint]
  DoStsEndpoint: !Equals ['true', !Ref EnableStsEndpoint]
  DoSecretsManagerEndpoint: !Equals ['true', !Ref EnableSecretsManagerEndpoint]
  DoSqsEndpoint: !Equals ['true', !Ref EnableSqsEndpoint]
  DoSnsEndpoint: !Equals ['true', !Ref EnableSnsEndpoint]
  DoMonitoringEndpoint: !Equals ['true', !Ref EnableMonitoringEndpoint]
  DoEcrEndpoints: !Equals ['true', !Ref EnableEcrEndpoints]

Resources:
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      EnableDnsSupport: "true"
      EnableDnsHostnames: "true"
      CidrBlock: !Ref VpcCidr
  PublicSubnet:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 0
      - Fn::GetAZs: !Ref "AWS::Region"
  PublicSubnet2:
    Type: "AWS::EC2::Subnet"
    Condition: DoAz2
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 1
      - Fn::GetAZs: !Ref "AWS::Region"
  PublicSubnet3:
    Type: "AWS::EC2::Subnet"
    Condition: DoAz3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [2, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 2
      - Fn::GetAZs: !Ref "AWS::Region"
  InternetGateway:
    Type: "AWS::EC2::InternetGateway"
  GatewayToInternet:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  PublicRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
  PublicRoute:
    Type: "AWS::EC2::Route"
    DependsOn: GatewayToInternet
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  PublicSubnetRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  PublicSubnetRouteTableAssociation2:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: DoAz2
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
  PublicSubnetRouteTableAssociation3:
    Condition: DoAz3
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable
  PrivateSubnet:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [3, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 0
      - Fn::GetAZs: !Ref "AWS::Region"
  PrivateRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
  PrivateSubnetRouteTableAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable
  NAT:
    DependsOn:
    - GatewayToInternet
    Type: "AWS::EC2::NatGateway"
    Condition: DoNat
    Properties:
      AllocationId:
        "Fn::GetAtt":
        - EIP
        - AllocationId
      SubnetId: !Ref PublicSubnet
  EIP:
    Type: "AWS::EC2::EIP"
    Condition: DoNat
    Properties:
      Domain: vpc
  Route:
    Type: "AWS::EC2::Route"
    Condition: DoNat
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NAT
  PrivateSubnet2:
    Type: "AWS::EC2::Subnet"
    Condition: DoAz2
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [4, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 1
      - Fn::GetAZs: !Ref "AWS::Region"
  PrivateRouteTable2:
    Type: "AWS::EC2::RouteTable"
    Condition: DoAz2
    Properties:
      VpcId: !Ref VPC
  PrivateSubnetRouteTableAssociation2:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: DoAz2
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2
  NAT2:
    DependsOn:
    - GatewayToInternet
    Type: "AWS::EC2::NatGateway"
    Condition: DoNatAz2
    Properties:
      AllocationId:
        "Fn::GetAtt":
        - EIP2
        - AllocationId
      SubnetId: !Ref PublicSubnet2
  EIP2:
    Type: "AWS::EC2::EIP"
    Condition: DoNatAz2
    Properties:
      Domain: vpc
  Route2:
    Type: "AWS::EC2::Route"
    Condition: DoNatAz2
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NAT2
  PrivateSubnet3:
    Type: "AWS::EC2::Subnet"
    Condition: DoAz3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [5, !Cidr [!Ref VpcCidr, 6, !Ref SubnetBits]]
      AvailabilityZone: !Select
      - 2
      - Fn::GetAZs: !Ref "AWS::Region"
  PrivateRouteTable3:
    Type: "AWS::EC2::RouteTable"
    Condition: DoAz3
    Properties:
      VpcId: !Ref VPC
  PrivateSubnetRouteTableAssociation3:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: DoAz3
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable3
  NAT3:
    DependsOn:
    - GatewayToInternet
    Type: "AWS::EC2::NatGateway"
    Condition: DoNatAz3
    Properties:
      AllocationId:
        "Fn::GetAtt":
        - EIP3
        - AllocationId
      SubnetId: !Ref PublicSubnet3
  EIP3:
    Type: "AWS::EC2::EIP"
    Condition: DoNatAz3
    Properties:
      Domain: vpc
  Route3:
    Type: "AWS::EC2::Route"
    Condition: DoNatAz3
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable3
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NAT3
  EndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTPS from VPC for VPC Endpoints
      VpcId: !Ref VPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: !Ref VpcCidr
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoS3Endpoint
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal: '*'
          Action:
          - '*'
          Resource:
          - '*'
      RouteTableIds:
      - !Ref PublicRouteTable
      - !Ref PrivateRouteTable
      - !If [DoAz2, !Ref PrivateRouteTable2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateRouteTable3, !Ref "AWS::NoValue"]
      ServiceName: !Join
      - ''
      - - com.amazonaws.
        - !Ref 'AWS::Region'
        - .s3
      VpcId: !Ref VPC
  DynamoDbEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoDynamoDbEndpoint
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal: '*'
          Action:
          - '*'
          Resource:
          - '*'
      RouteTableIds:
      - !Ref PublicRouteTable
      - !Ref PrivateRouteTable
      - !If [DoAz2, !Ref PrivateRouteTable2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateRouteTable3, !Ref "AWS::NoValue"]
      ServiceName: !Sub com.amazonaws.${AWS::Region}.dynamodb
      VpcId: !Ref VPC
  SsmEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSsmEndpoints
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssm
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  Ec2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSsmEndpoints
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ec2messages
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  SsmMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSsmEndpoints
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssmmessages
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  EcrApiEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoEcrEndpoints
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.api
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  EcrDkrEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoEcrEndpoints
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.dkr
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  LogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoLogsEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  KmsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoKmsEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.kms
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  StsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoStsEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.sts
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  SecretsManagerEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSecretsManagerEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  SqsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSqsEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.sqs
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  SnsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoSnsEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.sns
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup
  MonitoringEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: DoMonitoringEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.monitoring
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
      - !Ref PrivateSubnet
      - !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
      - !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
      SecurityGroupIds:
      - !Ref EndpointSecurityGroup

Outputs:
  VpcId:
    Description: ID of the new VPC.
    Value: !Ref VPC
  PublicSubnetIds:
    Description: Subnet IDs of the public subnets.
    Value:
      !Join [
        ",",
        [!Ref PublicSubnet, !If [DoAz2, !Ref PublicSubnet2, !Ref "AWS::NoValue"], !If [DoAz3, !Ref PublicSubnet3, !Ref "AWS::NoValue"]]
      ]
  PrivateSubnetIds:
    Description: Subnet IDs of the private subnets.
    Value:
      !Join [
        ",",
        [!Ref PrivateSubnet, !If [DoAz2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"], !If [DoAz3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]]
      ]
  PublicRouteTableId:
    Description: Public Route table ID
    Value: !Ref PublicRouteTable
  PrivateRouteTableIds:
    Description: Private Route table IDs
    Value:
      !Join [
        ",",
        [
          !Join ["=", [
            !Select [0, "Fn::GetAZs": !Ref "AWS::Region"],
            !Ref PrivateRouteTable
          ]],
          !If [DoAz2,
               !Join ["=", [!Select [1, "Fn::GetAZs": !Ref "AWS::Region"], !Ref PrivateRouteTable2]],
               !Ref "AWS::NoValue"
          ],
          !If [DoAz3,
               !Join ["=", [!Select [2, "Fn::GetAZs": !Ref "AWS::Region"], !Ref PrivateRouteTable3]],
               !Ref "AWS::NoValue"
          ]
        ]
      ]
